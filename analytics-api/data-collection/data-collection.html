<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Data Collection Sample</title>
	<style>
		body {
			font-family: Helvetica, Arial, sans-serif;
			margin-top: 40px;
			margin-left: 40px;
		}
		.analytics-event {
			color: #ff0000;
		}
		.player-event {
			color: #6e9fb3;
		}
		.legend {
			width: 1em;
		}
		div#player {
			float: left;
			margin-right: 20px;
		}
		div.event-log {
			border: 1px #6e9fb3 solid;
			border-radius: 5px;
			display: inline-block;
            font-size: .6em;
			padding: 10px;
			min-height: 260px;
		}
	</style>
</head>

<body>
	<h1>Data Collection Sample</h1>
	<div id="player">
		<!-- Start of Brightcove Player -->
		<script language="JavaScript" type="text/javascript" src="http://admin.brightcove.com/js/BrightcoveExperiences.js"></script>
		<object id="myExperience928199562001" class="BrightcoveExperience">
			<param name="bgcolor" value="#FFFFFF" />
			<param name="width" value="480" />
			<param name="height" value="270" />
			<param name="playerID" value="921267190001" />
			<param name="playerKey" value="AQ~~,AAAA1oy1bvE~,ALl2ezBj3WG3MLvDx9F9zkV06cNK00ey" />
			<param name="isVid" value="true" />
			<param name="isUI" value="true" />
			<param name="dynamicStreaming" value="true" />
			<param name="@videoPlayer" value="928199562001" />
			<param name="includeAPI" value="true" />
			<param name="templateLoadHandler" value="BCLS.onTemplateLoaded" />
			<param name="templateReadyHandler" value="BCLS.onTemplateReady">
		</object>
		<script type="text/javascript">
			brightcove.createExperiences();
		</script>
		<!-- End of Brightcove Player -->
	</div>
	<div id="eventLog" class="event-log"></div>
	<div>
		<p>
			<button id="changeVideoBtn">Change Video</button>
		</p>
		<p>
			<button id="resetBtn">Reset</button>
		</p>
	</div>
	</div>
	<form id="analyticsRequest" action="">
		<input id="requestURL" type="hidden" />
	</form>
	<script>
		var BCLS = (function (brightcove, window, document, console) {
			"use strict";
			var counter = 0, // counter for progress events
				// page elements
				eventLog = document.getElementById("eventLog"),
				changeVideoBtn = document.getElementById("changeVideoBtn"),
				resetBtn = document.getElementById("resetBtn"),
				analyticsRequest = document.getElementById("anaylyticsRequest"),
				requestURL = document.getElementById("requestURL"),
				// data-collection api
				baseURL = "http://metrics.brightcove.com/tracker?",
				// location properties
				destination = window.location.pathname,
    			source = document.referrer,
    			/* account, player id and initial video id 
    			 * easier to hard-code this
    			 * possible but tedious to get player and video IDs via JavaScript
    			 */
    			account = 921483702001,
    			playerID = 921267190001,
    			videoID = 928199562001,
    			// for Smart Player API references
    			player,
    			modVP,
    			videosToSwap = [928199562001, 2101639723001], // videos we will swap
    			currentVideoDTO = {}, // use this to hold the video info object
    			// functions
    			onTemplateLoaded,
    			onTemplateReady,
    			onMediaEventFired,
    			changeVideo,
    			getVideoDTO,
    			logEvent,
    			sendAnalyticsEvent,
    			reset;
			// event logger
			logEvent = function (str) {
				eventLog.innerHTML += str + "<br />";
			};
			// send video impression event
			sendAnalyticsEvent = function (eventType, evt) {
				var date = new Date(),
					dateTime = date.valueOf();
				urlStr = baseURL + "event=" + eventType + "&domain=videocloud$account=" + account + "&player=" + playerID + "&video=" + videoID + "&time=" + dateTime + "&destination=" + destination;
				if (source !== "") {
    				urlStr += "&source=" + source;
				}
				if (eventType === "video_view") {
    				urlStr += ;
				}
			}
			// player load handler
			onTemplateLoaded = function (experienceID) {
				var str = "";
				// log the player event
				str = "<span class=\"player-event\">Player event: player loaded</span>";
				logEvent(str);
				// send player_load event
				sendAnalyticsEvent("player_load", {})
				// player modules
				player = brightcove.api.getExperience(experienceID);
				modVP = player.getModule(brightcove.api.modules.APIModules.VIDEO_PLAYER);
				// document event handlers
				changeVideoBtn.addEventListener("click", BCLS.changeVideo);
				resetBtn.addEventListener("click", BCLS.reset);
			};
			// player ready handler
			onTemplateReady = function (evt) {
				// set up media event listeners
				modVP.addEventListener(brightcove.api.events.MediaEvent.BEGIN, BCLS.onMediaEventFired);
				modVP.addEventListener(brightcove.api.events.MediaEvent.CHANGE, BCLS.onMediaEventFired);
				modVP.addEventListener(brightcove.api.events.MediaEvent.COMPLETE, BCLS.onMediaEventFired);
				modVP.addEventListener(brightcove.api.events.MediaEvent.PROGRESS, BCLS.onMediaEventFired);
				// get the initial video DTO
				getVideoDTO();
			};
			// media event handler
			onMediaEventFired = function (evt) {
				var str = "";
				console.log(evt);
				switch (evt.type) {
				case "mediaBegin":
					str = "<span class=\"player-event\">Player event: video begin</span>";
					logEvent(str);
					// send video_view event
					sendAnalyticsEvent("video_view", evt);
					break;
				case "mediaComplete":
					// log player evt
					str = "<span class=\"player-event\">Player event: video complete</span>";
					logEvent(str);
					changeVideo();
					break;
				case "mediaProgress":
					if (counter % 100 === 0) {
						// log player event
						str = "<span class=\"player-event\">Player event: progress (" + counter + ")</span>";
						logEvent(str);
						// send video_enagement event
						sendAnalyticsEvent("video_engagement", evt)
					}
					counter++;
					break;
				case "mediaChange":
					// log player event
					str = "<span class=\"player-event\">Player event: video change</span>";
					logEvent(str);
				    getVideoDTO();
					break;
				default:
					// log other player event
					str = "<span class=\"player-event\">Player event:" + evt.type + "</span>";
					logEvent(str);
					break;
				}
			};
			// video swapper
			changeVideo = function () {
				console.log("change");
				modVP.getCurrentVideo(function (dto) {
					if (dto.id === videosToSwap[0]) {
						modVP.loadVideoByID(videosToSwap[1]);
					} else {
						modVP.loadVideoByID(videosToSwap[0]);
					};
					// update video DTO
					getVideoDTO();
				});
			};
			// get the current video DTO
			getVideoDTO = function () {
    			modVP.getCurrentVideo(function (dto) {
        			currentVideoDTO = dto;
					videoID = currentVideoDTO.id;
    			});
			}
			// empty the log, reset the counter
			reset = function (currentVideo) {
				document.getElementById("eventLog").innerHTML = "";
				counter = 0;
			};
			return {
				"onTemplateLoaded": onTemplateLoaded,
				"onTemplateReady": onTemplateReady,
				"onMediaEventFired": onMediaEventFired,
				"changeVideo": changeVideo,
				"reset": reset
			};
		})(brightcove, window, document, console);
	</script>
</body>

</html>