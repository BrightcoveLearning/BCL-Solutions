<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Analytics API Solution: Geographical Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Robert Crooks">

    <!--link rel="stylesheet/less" href="less/bootstrap.less" type="text/css" /-->
    <!--link rel="stylesheet/less" href="less/responsive.less" type="text/css" /-->
    <!--script src="/bcls/bootstrap/js/less-1.3.3.min.js"></script-->
    <!--append ‘#!watch’ to the browser URL, then refresh the page. -->

    <link href="/bcls/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/bcls/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/bcls/bootstrap/css/style.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="//docs.brightcove.com/en/styles/bcls-doc-site.css">
    <!-- for date picker -->
    <link href="/bcls/scripts/datepickr_2/datepickr.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="/bcls/bootstrap/js/html5shiv.js"></script>
  <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/bcls/bootstrap/img/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/bcls/bootstrap/img/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/bcls/bootstrap/img/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/bcls/bootstrap/img/apple-touch-icon-57-precomposed.png">
    <link rel="shortcut icon" href="/bcls/bootstrap/img/favicon.ico">
    <style type="text/css">
    body {
        margin: 40px;
    }
    </style>

</head>

<body data-spy="scroll" data-target=".sub-menu" data-offset="100">
    <!-- header navbar -->
    <div id="titleBar" class="navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
            <div id="otherSites">
                <ul class="nav pull-right small">
                    <li>
                        <a href="//brightcove.com">BRIGHTCOVE.COM</a>
                    </li>
                    <li>
                        <a href="//support.brightcove.com">SUPPORT</a>
                    </li>
                    <li>
                        <a href="//support.brightcove.com/video-cloud/training-videos">TRAINING VIDEOS</a>
                    </li>
                </ul>
            </div>
            <a class="brand" href="//docs.brightcove.com/en/index.html">BRIGHTCOVE DEVELOPER DOCUMENTATION</a>
        </div>
    </div>
    <!-- end header navbar -->
    <!-- nav navbar -->
    <div id="navBar" class="navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
            <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
            <a class="btn btn-navbar pull-right" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>
            <!-- Everything you want hidden at 940px or less, place within here -->
            <ul id="sectionNav" class="nav">
            </ul>
        </div>
    </div>
    <!-- end nav navbar -->
    <!-- main content starts here -->
    <div class="row">
        <div id="sidenav" class="span2"></div>
        <div id="main" class="span10">
            <div class="section" id="top">
                <h1>Analytics API Solution: Geographical Report</h1>
                <p>The Analytics UI in Video Cloud Studio offers a number of ready-made reports, but you can create additional reports using he Analytics API that are tailored to your specific needs. In this example, we will get video views by geographical locations</p>
                <div class="text-warning">
                    <h3>Dependencies</h3>
                    <p>3rd party libraries used in this sample:</p>
                    <ul>
                        <li><a href="https://jquery.org">jQuery</a></li>
                        <li><a href="http://handlebarsjs.com">Handlebars</a></li>
                        <li><a href="//code.google.com/p/datepickr/">DatePickr</a></li>
                        <li><a href="http://www.flotcharts.org">Flot</a></li>
                    </ul>
                </div>
            </div>
            <div class="section" id="inputs">
                <h2>Inputs</h2>
                <fieldset>
                    <legend>Basic Information</legend>
                    <div id="basicInfo">
                        <table>
                            <tbody>
                                <tr>
                                    <td>Video Cloud Account (Publisher ID):</td>
                                    <td><input id="accountID" class="required aapi-request" type="text" size="55" value="20318290001"> (default: BC Training Videos)</td>
                                </tr>
                                <tr>
                                    <td class="align-top no-wrap">Authorization Token:<sup class="red">*</sup></td>
                                    <td><input id="token" class="required aapi-request" type="text" size="55" value="15075c51ae4b0af095c9a619a" /> (default: BC Training Videos)<p><sup class="red">*</sup>If your account has been enabled for the Analytics API, this token was emailed to the account administrator when you joined the <strong>limited availability</strong> program.</p></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Report Options</legend>
                    <h4>Geo options</h4>
                    <p>Select the geographical entity to chart video views by:<br />
                        <select id="geoSelector">
                            <option selected="selected" value="country">Country</option>
                            <option value="region">Region</option>
                            <option value="city">City</option>
                        </select>
                    </p>
                    <h4>Date Range</h4>
                    <p>
                        Start: <input id="fromDatePicker" size="30" /> (default: 30 days ago)
                    </p>
                    <p>
                        End: &nbsp;<input id="toDatePicker" size="30" /> (default: today)
                    </p>
                    <h4>Limiting Results</h4>
                    <p>
                        Number of items to return: <input id="limit" size="10" value="10" />
                    </p>
                    <p>
                        Number of items to skip: <input id="offset" size="10" value="0" />
                    </p>
                    <p>
                        <span class="BCL-btn" id="getData">Get Data for the Account</span>
                    </p>
                    <h2>Video and Player Options</h2>
                    <p>To get results for a specific video and/or player, make a selection below</p>
                    <p>
                        <select id="playerSelector"></select>
                        <select id="videoSelector"></select>
                    </p>
                    <p class="text-warning" id="gettingDataDisplay"></p>
                </fieldset>
            </div>
            <div class="section" id="results">

                <div id="video_player_info"></div>
                <table>
                    <thead>
                        <tr>
                            <th>Country</th>
                            <th>Region</th>
                            <th>City</th>
                            <th>Video Views</th>
                            <th>Average Viewed Seconds</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
                <h4>Video Views by Geo</h4>
                <div id="chartView" width="700" height="400" style="width:700px;height:400px"></div>
                <div id="chartViewLegend" style="padding:10px 20px;"></div>
            </div>
            <div class="section" id="code">
              <h2>Code for the sample</h2>
              <p>The JavaScript code for this sample is shown below &mdash; view source to see the full page code.<p>
              <!-- gist embed here -->
            </div>
        </div>
    </div>
    <!-- jquery used for the AJAX calls -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//docs.brightcove.com/en/scripts/bootstrap/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-smooth-scroll/1.4.12/jquery.smooth-scroll.min.js"></script>
    <!-- handlebars used to merge data with HTML strings -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.1.2/handlebars.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.4/highlight.min.js"></script>
    <!-- chart.js charting package -->
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/flot/0.8.1/jquery.flot.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/flot/0.8.1/jquery.flot.categories.min.js"></script>
    <!-- for date picker -->
    <script type="text/javascript" src="/bcls/scripts/datepickr_2/datepickr.min.js"></script>
    <script src="//docs.brightcove.com/en/scripts/docs-nav-data.min.js"></script>
    <script src="//docs.brightcove.com/en/scripts/bcls-doc-site.js"></script>
    <script id="pageScript" type="text/javascript">
        var BCLS = (function () {
            var callNumber = 0,
                $accountID = $("#accountID"),
                $token = $("#token"),
                $dateSelector = $("#dateSelector"),
                $playerSelector = $("#playerSelector"),
                $videoSelector = $("#videoSelector"),
                $reportTableBody = $("#reportTableBody"),
                $fromDate = $("#fromDatePicker"),
                $toDate = $("#toDatePicker"),
                $getData = $("#getData"),
                $gettingDataDisplay = $("#gettingDataDisplay"),
                $video_player_info = $("#video_player_info"),
                currentPlayer,
                currentVideo,
                playerMax,
                videoMax,
                videoData,
                playerData,
                analyticsData = {},
                playerID,
                videoID,
                dataDisplayBodyTemplate = "<td>{{video_name}}</td><td>Totals</td><td>{{totalPlays}}</td><td>{{totalCompletedViews}}</td><td>{{totalAvgSecondsViewed}}</td><td>{{totalSecondsViewed}}</td></tr>{{#items}}<tr><td></td><td></td><td>{{date}}</td><td>{{video_view}}</td><td>{{completionRate}}</td><td>{{avgSecondsViewed}}</td><td>{{totalSecondsViewed}}</td></tr>{{/items}}",
                playerSelectTemplate = "{{#items}}<option value=\"{{player}}\">{{player_name}}</options>{{/items}}",
                videoSelectTemplate = "{{#items}}<option value=\"{{video}}\">{{video_name}}</options>{{/items}}",
                callType,
                displayData = function () {
                    var displayStr, playerObject, videoObject, template, barChartData, chart;
                    currentPlayer = $playerSelector.filter(":selected").text();
                    currentVideo = $videoSelector.filter(":selected").text();
                    displayStr = "";
                    if (currentPlayer !== "") {
                        displayStr += "Player: " + currentPlayer + " ";
                    }
                    if (currentVideo !== "") {
                        displayStr += "Video: " + currentVideo;
                    }
                    video_player_info.html("displayStr");
                    // chart
                    barChartData = videoObject.chartData;
                    $.plot("#chartView", [ barChartData ], {
                        series: {
                            bars: {
                                show: true,
                                barWidth: 0.6,
                                align: "center"
                            }
                        },
                        xaxis: {
                            mode: "categories",
                            tickLength: 0
                        }
                    });
                },
                makeAnalyticsCall = function (callURL) {
                    $.ajax({
                    url: callURL,
                    headers: {
                        Authorization : "Bearer " + token.value
                    },
                    success : function (data) {
                        var template, results, i, j, k, player, video, itemsmax, analytics, item, newItem = {}, thisVideo;
                        switch (callType) {
                            case "players":
                                callNumber++;
                                // save the data for getting the analytics
                                playerData = data;
                                playerMax = playerData.items.length;
                                // add players to the analytics data object
                                for (i = 0; i < playerMax; i++) {
                                    analyticsData[playerData.items[i].player] = {};
                                    analyticsData[playerData.items[i].player].player_name = playerData.items[i].player_name;
                                    analyticsData[playerData.items[i].player].items = [];
                                }
                                // populate the player selector
                                template = Handlebars.compile(playerSelectTemplate);
                                playerSelector.innerHTML = template(data);
                                playerSelector.options[0].setAttribute("selected", "selected");
                                getVideoData();
                                break;
                            case "videos":
                                callNumber++;
                                // save the data for getting the analytics
                                videoData = data;
                                videoMax = videoData.items.length;
                                // add videos to the analytics data object
                                for (player in analyticsData) {
                                    for (j = 0; j < videoMax; j++) {
                                        video = videoData.items[j];
                                        analyticsData[player].items[j] = {};
                                        analyticsData[player].items[j].id = video.video;
                                        analyticsData[player].items[j].video_name = video.video_name;
                                        analyticsData[player].items[j].items = [];
                                    }
                                }
                                // populate the video selector
                                template = Handlebars.compile(videoSelectTemplate);
                                videoSelector.innerHTML = template(data);
                                videoSelector.options[0].setAttribute("selected", "selected");
                                getAnalyticsData();
                                break;
                            case "analytics":
                                callNumber++;
                                itemsmax = data.items.length;
                                videoMax = analyticsData[currentPlayer].items.length;
                                for (k = 0; k < videoMax; k++) {
                                    thisVideo = analyticsData[currentPlayer].items[k];
                                    newItem = {};
                                    newItem.video_view = 0;
                                    newItem.completionRate = 0;
                                    newItem.avgSecondsViewed = 0;
                                    newItem.totalSecondsViewed = 0;
                                    newItem.day = currentDay.from;
                                    for (i = 0; i < itemsmax; i++) {
                                        if (data.items[i].video === thisVideo.id) {
                                            item = data.items[i];
                                            newItem.video_view = item.video_view;
                                            newItem.completionRate = Math.round(item.video_engagement_100 / item.video_view);
                                            newItem.avgSecondsViewed = item.video_seconds_viewed / item.video_view;
                                            newItem.totalSecondsViewed = item.video_seconds_viewed;
                                        }
                                    }
                                    analyticsData[currentPlayer].items[k].items.push(newItem);
                                }
                                if (currentDayIndex < dayMax - 1) {
                                    currentDayIndex++;
                                    getAnalyticsData();
                                } else if (currentPlayerIndex < playerMax - 1) {
                                    currentDayIndex = 0;
                                    currentVideoIndex = 0;
                                    currentPlayerIndex++;
                                    getAnalyticsData();
                                } else {
                                    gettingDataDisplay.innerHTML = "Data retrieved - " + callNumber + " API calls made";
                                    getTotals();
                                }
                        }
                    },
                    error : function (XMLHttpRequest, textStatus, errorThrown)
                        {
                            gettingDataDisplay.innerHTML = "Sorry, your request was not successful. Here's what the server sent back: " + errorThrown;
                        }
                    });
                },
                // get the analytics data for the videos
                getAnalyticsData = function () {
                    var callURL;
                    gettingDataDisplay.innerHTML = "Getting analytics data...";
                    callType = "analytics";
                    currentPlayer = playerData.items[currentPlayerIndex].player;
                    // currentVideo = videoData.items[currentVideoIndex].video;
                    currentDay = daysArray[currentDayIndex];
                    callURL = "https://data.brightcove.com/analytics-api/videocloud/account/" + accountID.value + "/report/?dimensions=video&from=" + currentDay.from + "&to=" + currentDay.to + "&where=player==" + currentPlayer + "&fields=video_view,video_seconds_viewed,video,video_engagement_100";
                    makeAnalyticsCall(callURL);

                },
                /** get the videos for the time period
                * note the limit of 200 videos - to get more simply
                * change that value, or you could provide an additional field
                * to let the user decide how many to retrieve
                */
                getVideoData = function () {
                    var callURL = "";
                    gettingDataDisplay.innerHTML = "Getting video data...";
                    callType = "videos";
                    callURL = "https://data.brightcove.com/analytics-api/videocloud/account/" + accountID.value + "/report/?dimensions=video&limit=200&fields=video,video_name&sort=video_view&from=" + $fromDate.val() + "&to=" + $toDate.val();
                    makeAnalyticsCall(callURL);
                },
                /** get the players for the time period
                * note the limit of 100 players - to get more simply
                * change that value, or you could provide an additional field
                * to let the user decide how many to retrieve
                */
                getPlayersData = function () {
                    var callURL = "";
                    gettingDataDisplay.innerHTML = "Getting player data...";
                    callType = "players";
                    callURL = "https://data.brightcove.com/analytics-api/videocloud/account/" + accountID.value + "/report/?dimensions=player&limit=100&fields=player,player_name&sort=video_view&from=" + dateFromMS + "&to=" + dateToMS;
                    makeAnalyticsCall(callURL);
                };
            // add date pickers to the date input fields
            new datepickr('fromDatePicker', {
                'fullCurrentMonth': false,
                'dateFormat': 'Y-m-d'
            });
            new datepickr('toDatePicker', {
                'fullCurrentMonth': false,
                'dateFormat': 'Y-m-d'
            });

            // set event listeners

            $videoSelector.on("change", displayData);
            $playerSelector.on("change", displayData);
            return {
            }
        })();
    </script>
</body>

</html>
