<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Dynamic Ingest Log</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 4em;
            }
            .hide {
                display: none;
            }
            .show {
                display: block;
            }
        </style>
    </head>
    <body>
        <h1>Dynamic Ingest Log</h1>
        <h2>Account: Brightcove Learning (57838016001)</h2>
        <div id="videoLogBlock">
            <table>
                <thead>
                    <tr>
                        <th>Video ID</th>
                        <th>Name</th>
                        <th>Renditions created</th>
                    </tr>
                </thead>
                <tbody id="logBody"></tbody>
            </table>
        </div>
        <script src="video-ids.js"></script>
        <script>
        var BCLS = ( function (videoIdArray) {
            var tr,
                logBody = document.getElementById('logBody');
                i = 0,
                iMax = videoIdArray.length,
                proxyURL = 'https://solutions.brightcove.com/bcls/bcls-proxy/bcls-proxy.php',
                videoDataArray = [],
                videoDataItem = {},
                requestOptions = {},
                currentVideo,
                // functions
                submitRequest,
                setVideoRequestOptions,
                setSourcesRequestOptions,
                getVideoInfo,
                writeReport,
                bclslog;

                /**
                 * Logging function - safe for IE
                 * @param  {string} context - description of the data
                 * @param  {*} message - the data to be logged by the console
                 * @return {}
                 */
                bclslog = function (context, message) {
                    if (window["console"] && console["log"]) {
                      console.log(context, message);
                    }
                    return;
                };

                // function to set up video data request
                setVideoRequestOptions = function () {
                    requestOptions = {};
                    requestOptions.client_id = '553d4903-4547-435d-944c-2c8e2f6abc5d';
                    requestOptions.client_secret = 'ENBQH6pHfJQub7oR0SGCn2Pu_W2SY5QsVw24fK-frXcE6hdTRnJO-0_LBmKZh15rVliIAiECAQF1yBYP_l90gQ';
                    requestOptions.url = 'https://cms.api.brightcove.com/v1/accounts/57838016001/videos/' + currentVideo;
                    submitRequest(requestOptions, 'video');
                };
                // function to set up video sources request
                setSourcesRequestOptions = function () {
                    requestOptions.url += '/sources';
                    submitRequest(requestOptions, 'sources');
                };

                // initiates the cms api requests
                getVideoInfo = function () {
                    currentVideo = videoIdArray[i];
                    setVideoRequestOptions();
                };

                // function to make the cms api requests
                submitRequest = function (options, type) {
                    var httpRequest = new XMLHttpRequest(),
                        requestData,
                        responseData,
                        parsedData,
                        getResponse = function () {
                            try {
                                if (httpRequest.readyState === 4) {
                                  if (httpRequest.status === 200) {
                                    logResponse(type, httpRequest.responseText);
                                    responseData = httpRequest.responseText;
                                    switch (type) {
                                        case "video":
                                        videoDataItem = {};
                                        if (responseData.indexOf("TIMEOUT") > 0) {
                                            t1 = setTimeout(setVideoRequestOptions, 1000);
                                        } else {
                                            parsedData = JSON.parse(responseData);
                                            videoDataItem.id = currentVideo;
                                            videoDataItem.name = parsedData.name;
                                            setSourcesRequestOptions();
                                        }
                                        break;
                                        case "sources":
                                        if (responseData.indexOf("TIMEOUT") > 0) {
                                            t1 = setTimeout(setSourcesRequestOptions, 1000);
                                        } else {
                                            parsedData = JSON.parse(responseData);
                                            videoDataItem.sosources = parsedData.length;
                                            videoDataArray.push(videoDataItem);
                                            if (i < iMax) {
                                                getVideoInfo();
                                            } else {
                                                writeReport();
                                            }
                                        }
                                        break;
                                    }
                                  } else {
                                    alert("There was a problem with the request. Request returned " + httpRequest.status);
                                  }
                                }
                              }
                              catch(e) {
                                alert('Caught Exception: ' + e);
                              }
                        };
                    // set up request data
                    requestData = "client_id=" + options.client_id + "&client_secret=" + options.client_secret + "&url=" + encodeURIComponent(options.url) + "&requestType=GET";
                    // set response handler
                    httpRequest.onreadystatechange = getResponse;
                    // open the request
                    httpRequest.open("POST", proxyURL);
                    // set headers
                    httpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    // open and send request
                    httpRequest.send(requestData);
                };

                bclslog('videoIdArray', videoIdArray);
                iMax = videoIdArray.length;
                for (i = 0; i < iMax; i++) {
                    currentVideo = videoIdArray[i];
                    setVideoRequestOptions();
                }

            })(videoIdArray);
        </script>
    </body>
</html>
