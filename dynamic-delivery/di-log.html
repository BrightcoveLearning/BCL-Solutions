<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Dynamic Ingest Log</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 5em;
            }
            .hide {
                display: none;
            }
            .show {
                display: block;
            }
            table {
                border-collapse: collapse;
                border: 1px #999999 solid;
            }
            th {
                background-color: #666666;
                color: #f5f5f5;
                padding: .5em;
                font-size: .7em;
            }
            td {
                border: 1px #999999 solid;
                font-size: .7em;
                padding: .5em
            }
            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <h1>Dynamic Ingest Log</h1>
        <h2>Account: Brightcove Learning (57838016001)</h2>
        <p style="width:70%">
            Videos are listed in order of processing completion time, newest to oldest. The reference id (generated by the <a href="./di-tester.html">Dynamic Ingest tester</a>) is a combination of the date/time that the Dynamic Ingest job was initiated and the ingest profile that was used. You can add additional videos using the <a href="./di-tester.html">Dynamic Ingest tester</a>. New videos will appear in this log after processing is complete.
        </p>
        <p>
            <button id="clearLogBtn">Clear the log</button>
        </p>
        <div id="videoLogBlock">
            <table>
                <thead>
                    <tr>
                        <th>Video ID</th>
                        <th>Name</th>
                        <th>Reference ID</th>
                        <th>HLS Manifests Created</th>
                        <th>HLS Renditions Created</th>
                        <th>MP4 Renditions Created</th>
                        <th>Processing Complete</th>
                    </tr>
                </thead>
                <tbody id="logBody"></tbody>
            </table>
            <h4 id="loadingMessage">Loading data, please wait...</h4>
        </div>
        <script>
        var BCLS = ( function (window, document) {
            // to use another account, set the account_id value appropriately
            // the client_id and client_secret will also need to be changed in the proxy
            var my_account_id = 57838016001,
                account_id = my_account_id,
                logBody = document.getElementById('logBody'),
                loadingMessage = document.getElementById('loadingMessage'),
                clearLogBtn = document.getElementById('clearLogBtn'),
                i = 0,
                iMax,
                // set the proxyURL to the location of the proxy app that makes Brightcove API requests
                proxyURL = './brightcove-learning-proxy.php',
                dataFileURL = './di.json',
                videoDataArray = [],
                requestOptions = {},
                currentVideo,
                currentIndex = 0;

                /**
                 * Logging function - safe for IE
                 * @param  {string} context - description of the data
                 * @param  {*} message - the data to be logged by the console
                 * @return {}
                 */
                function bclslog(context, message) {
                    if (window["console"] && console["log"]) {
                      console.log(context, message);
                    }
                    return;
                }

                /**
                 * tests for all the ways a variable might be undefined or not have a value
                 * @param {*} x the variable to test
                 * @return {Boolean} true if variable is defined and has a value
                 */
                function isDefined(x) {
                    if ( x === '' || x === null || x === undefined || x === NaN) {
                        return false;
                    }
                    return true;
                }

                /**
                 * find index of an object in array of objects
                 * based on some property value
                 *
                 * @param {array} targetArray - array to search
                 * @param {string} objProperty - object property to search
                 * @param {string|number} value - value of the property to search for
                 * @return {integer} index of first instance if found, otherwise returns null
                 */
                function findObjectInArray(targetArray, objProperty, value) {
                    var i, totalItems = targetArray.length, objFound = false;
                    for (i = 0; i < totalItems; i++) {
                        if (targetArray[i][objProperty] === value) {
                            objFound = true;
                            return i;
                        }
                    }
                    if (objFound === false) {
                        return null;
                    }
                }

                /**
                 * factory for new video objects
                 * @param {String} videoId the video id
                 * @return {object} the new object
                 */
                function makeVideoDataObject(videoId) {
                    var obj = {};
                    obj.id = videoId;
                    obj.name = '';
                    obj.reference_id = '';
                    obj.hlsManifests = 0;
                    obj.hlsRenditions = 0;
                    obj.mp4Renditions = 0;
                    obj.complete = 'no';
                    return obj;
                }

                /**
                 * processes notification objects
                 * creates a new object in the videoDataArray if it doesn't exist
                 * and updates the videoDataArray object based on the notification
                 * @param {Object} notificationObj the raw notification object
                 */
                function processNotification(notificationObj) {
                    var objIndex, videoObj;
                    // if notification object contains a video id, find the corresponding
                    // object in the videoDataArray or create it if it's not there
                    if (isDefined(notificationObj) && isDefined(notificationObj.videoId)) {
                        objIndex = findObjectInArray(videoDataArray, 'id', notificationObj.videoId);
                        // if not found, create one
                        if (!isDefined(objIndex)) {
                            videoObj = makeVideoDataObject(notificationObj.videoId);
                            videoDataArray.push(videoObj);
                            objIndex = videoDataArray.length - 1;
                        }
                        // now update properties based on what's in the notification
                        if (notificationObj.entityType === 'ASSET') {
                            // if it's a rendition or manifest, there will be a profileRefId
                            if (isDefined(notificationObj.profileRefId)) {
                                // see if it's an HLS manifest
                                if (notificationObj.profileRefId === 'HlsManifest') {
                                    // increment the hls manifest count
                                    videoDataArray[objIndex].hlsManifests++;
                                } else if (notificationObj.profileRefId.charAt(0) === 't') {
                                    // increment the hls rendition count
                                    videoDataArray[objIndex].hlsRenditions++;
                                } else if (notificationObj.profileRefId.charAt(0) === 'm') {
                                    // increment the mp4 rendition count
                                    videoDataArray[objIndex].mp4Renditions++;
                                }
                            }
                        } else if (notificationObj.entityType === 'TITLE') {
                            // overall processing notification - checked for SUCCESS / FAILED
                            if (notificationObj.status === 'SUCCESS') {
                                // mark complete
                                videoDataArray[objIndex].complete = 'yes';
                            } else if (notificationObj.status === 'FAILED') {
                                // mark failed
                                videoDataArray[objIndex].complete = 'failed';
                            }
                        }
                    }
                    return;
                }

                /**
                 * creates the dashboard table body
                 */
                function writeReport() {
                    var j,
                        jMax = videoDataArray.length,
                        item,
                        t;
                    loadingMessage.textContent = 'This page will refresh in 1 minute...';
                    /* just showing HLS and MP4 renditions, because
                     * that's all that will be produced in this account,
                     * but you could modify the notification handler and
                     * this page to handle other formats
                     */
                    for (j = 0; j < jMax; j++) {
                        item = videoDataArray[j];
                        if (item.id !== undefined) {
                            logBody.innerHTML += '<tr><td>' + item.id + '</td><td>' + item.name + '</td><td>' + item.reference_id + '</td><td>' + item.hlsManifests + '</td><td>' + item.hlsRenditions + '</td><td>' + item.mp4Renditions + '</td><td>' + item.complete + '</td></tr>';
                        }
                    }
                    // set timeout for refresh
                    t = window.setTimeout(init, 60000);
                };

                // function to set up the notification data request
                function setJSONRequestOptions() {
                    submitRequest(null, dataFileURL, 'notificationData');
                }

                // function to set up video data request
                function setVideoRequestOptions() {
                    requestOptions = {};
                    requestOptions.url = 'https://cms.api.brightcove.com/v1/accounts/' + account_id + '/videos/' + currentVideo.id;
                    submitRequest(requestOptions, proxyURL, 'video');
                }

                /**
                 * initiates the cms api requests
                 */
                function getVideoInfo() {
                    iMax = videoDataArray.length;
                    if (currentIndex < iMax) {
                        currentVideo = videoDataArray[currentIndex];
                        setVideoRequestOptions();
                    } else {
                        loadingMessage.innerHTML = 'No videos have been ingested - you can add some using the <a href="./di-tester.html">Dynamic Ingest tester</a>';
                    }
                }

                /**
                 * make the cms api requests
                 * @param {Object} options request options
                 * @param (String) url URL to send request to
                 * @param (String) type the request type
                 */
                function submitRequest(options, url, type) {
                    var httpRequest = new XMLHttpRequest(),
                        requestData,
                        responseData,
                        videoDataObject,
                        parsedData,
                        getResponse = function () {
                            try {
                                if (httpRequest.readyState === 4) {
                                  if (httpRequest.status === 200) {
                                    responseData = httpRequest.responseText;
                                    switch (type) {
                                        case 'notificationData':
                                        var k, kMax, dataArray;
                                        dataArray = JSON.parse(responseData);
                                        bclslog('dataArray', dataArray);
                                        // process the notifications
                                        kMax = dataArray.length;
                                        for (k = 0; k < kMax; k++) {
                                            processNotification(dataArray[k]);
                                        }
                                        getVideoInfo();
                                        break;
                                        case 'video':
                                        parsedData = JSON.parse(responseData);
                                        bclslog('parsedData', parsedData);
                                        videoDataArray[currentIndex].reference_id = parsedData.reference_id;
                                        videoDataArray[currentIndex].name = parsedData.name;
                                        currentIndex++;
                                        if (currentIndex < iMax) {
                                            currentVideo = videoDataArray[currentIndex];
                                            setVideoRequestOptions();
                                        } else {
                                            writeReport();
                                        }
                                        break;
                                    }
                                  } else {
                                    bclslog("There was a problem with the request. Request returned " + httpRequest.status);
                                    if (type === 'video') {
                                        setVideoRequestOptions();
                                    } else {
                                        setSourcesRequestOptions();
                                    }
                                  }
                                }
                              }
                              catch(e) {
                                bclslog('Caught Exception: ' + e);
                              }
                        };
                    // notifications data is a special case
                    if (type === 'notificationData') {
                        // set response handler
                        httpRequest.onreadystatechange = getResponse;
                        // open the request
                        httpRequest.open("GET", url);
                        // set headers
                        httpRequest.setRequestHeader("Content-Type", "application/json");
                        // open and send request
                        httpRequest.send();
                    } else {
                        // requests via proxy
                        // set up request data
                        requestData = "url=" + encodeURIComponent(options.url) + "&requestType=GET";
                        // set response handler
                        httpRequest.onreadystatechange = getResponse;
                        // open the request
                        httpRequest.open("POST", url);
                        // set headers
                        httpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                        // open and send request
                        httpRequest.send(requestData);
                    }
                };

                // event handlers
                clearLogBtn.addEventListener('click', function () {
                    if (window.confirm('Are you sure? This action cannot be undone!')) {
                        // if your clear-log app resides in another location, change the URL
                        window.location.href = 'clear-log.php';
                    }
                });

                // get things started
                function init() {
                    // clear table and the video data array
                    logBody.innerHTML = "";
                    videoDataArray = [];
                    setJSONRequestOptions();
                }
                // kick off the app
                init();
            })(window, document);
        </script>
    </body>
</html>
